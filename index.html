<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK KNIT FAB ‚Äî Yarn Ledger</title>

<!-- ===== THEME & UI ===== -->
<style>
:root{
  /* Dark theme (default) */
  --bg:#090d14;
  --card:#0f1522;
  --glass:rgba(255,255,255,.06);
  --text:#eaf1ff;
  --muted:#99a8c7;
  --line:rgba(255,255,255,.12);
  --accent:#35d7ff;
  --accent2:#00ffd5;
  --ok:#7dff8c;
  --bad:#ff6b81;
}
body.light{
  /* Light overrides */
  --bg:#f6f8fb;
  --card:#ffffff;
  --glass:rgba(0,0,0,.04);
  --text:#0b1326;
  --muted:#62708c;
  --line:rgba(0,0,0,.12);
  --accent:#0ea5ff;
  --accent2:#2ce6c9;
  --ok:#0fbf60;
  --bad:#d64a62;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1200px 600px at 80% -10%,rgba(53,215,255,.10),transparent 60%),
             radial-gradient(800px 500px at -10% 0,rgba(0,255,213,.10),transparent 50%),
             var(--bg);
  color:var(--text);
  font-family:Inter, ui-sans-serif, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
  -webkit-font-smoothing:antialiased;
}
.hidden{display:none}

/* Header / Brand */
.brand{
  position:sticky; top:0; z-index:50;
  backdrop-filter:blur(14px);
  background:linear-gradient(180deg,rgba(0,0,0,.28),rgba(0,0,0,.02));
  border-bottom:1px solid var(--line)
}
body.light .brand{
  background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.4))
}
.brand-inner{
  max-width:1200px; margin:auto; padding:14px 18px;
  display:flex; gap:12px; align-items:center
}
.dot{
  width:10px;height:10px;border-radius:999px;background:var(--accent2);
  box-shadow:0 0 18px var(--accent2), 0 0 34px var(--accent2), 0 0 2px var(--accent2)
}
.title{font-weight:900; letter-spacing:.3px}
.theme{
  margin-left:auto; border:1px solid var(--line); background:var(--glass);
  padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700
}

/* Layout */
.container{max-width:1200px; margin:auto; padding:18px}
.grid{display:grid; gap:14px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:960px){.grid-2,.grid-3{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,var(--card),rgba(0,0,0,0) 180%), var(--card);
  border:1px solid var(--line); border-radius:16px; padding:16px;
  box-shadow:0 24px 60px rgba(0,0,0,.22);
  animation:fadeUp .35s ease both
}
@keyframes fadeUp{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
select,input[type=date],input[type=number]{
  width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line);
  color:var(--text); background:transparent; outline:none;
  transition:border-color .2s ease, box-shadow .2s ease
}
select:focus, input:focus{box-shadow:0 0 0 3px rgba(53,215,255,.25); border-color:var(--accent)}

.actions{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0}
.btn{border:none; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; letter-spacing:.2px}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#001419}
.btn-ghost{background:transparent; border:1px solid var(--line); color:var(--text)}

.kpis{display:grid; gap:12px; grid-template-columns:repeat(4,1fr); margin:14px 0}
@media(max-width:960px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{
  padding:14px; border-radius:14px; background:var(--glass); border:1px solid var(--line);
  position:relative; overflow:hidden
}
.kpi::after{
  content:""; position:absolute; inset:auto -40% -65% -40%;
  height:140%; background:radial-gradient(260px 120px at 50% 100%,rgba(53,215,255,.08),transparent);
}
.kpi h3{margin:0 0 6px; font-size:12px; color:var(--muted)}
.kpi .val{font-size:22px; font-weight:900}

.tablewrap{background:var(--card); border:1px solid var(--line); border-radius:16px; overflow:hidden}
table{width:100%; border-collapse:collapse; font-size:14px}
th,td{padding:12px 10px; border-bottom:1px solid var(--line); text-align:left}
th{font-size:12px; color:var(--muted); background:linear-gradient(180deg,rgba(255,255,255,.06),transparent)}
tbody tr{transition:background .18s ease}
tbody tr:hover td{background:linear-gradient(90deg,rgba(53,215,255,.08),transparent)}
.pos{color:var(--ok); font-weight:800}
.neg{color:var(--bad); font-weight:800}

/* Floating Nav */
.nav{position:fixed; left:0; right:0; bottom:16px; display:flex; justify-content:center; z-index:60}
.nav-inner{
  display:flex; gap:10px; background:rgba(255,255,255,.06);
  border:1px solid var(--line); backdrop-filter:blur(18px);
  border-radius:22px; padding:8px; box-shadow:0 24px 80px rgba(0,0,0,.35)
}
body.light .nav-inner{background:rgba(0,0,0,.04)}
.tab{display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:14px; cursor:pointer; user-select:none}
.tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#001419; font-weight:900}

/* Modal */
#modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:100}
#modal.open{display:flex}
#modal .card{max-width:520px; width:92%; animation:pop .22s ease}
@keyframes pop{from{opacity:0; transform:scale(.95)} to{opacity:1; transform:scale(1)}}

/* Utility */
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.toast{position:fixed; right:16px; bottom:86px; background:var(--glass); border:1px solid var(--line); padding:10px 12px; border-radius:12px; display:none}
.toast.show{display:block}
</style>
</head>

<body>
  <!-- ===== Brand Header ===== -->
  <div class="brand">
    <div class="brand-inner">
      <span class="dot"></span>
      <div class="title">RK KNIT FAB ‚Äî Yarn Ledger</div>
      <button id="themeBtn" class="theme" title="Toggle theme">üåó Theme</button>
    </div>
  </div>

  <!-- ===== Main Content ===== -->
  <div class="container">
    <!-- HOME -->
    <section id="view-home">
      <div class="grid grid-3">
        <div class="card">
          <label>Quick Party</label>
          <select id="homeParty"></select>
        </div>
        <div class="card">
          <label>Quick Yarn</label>
          <select id="homeYarn"></select>
        </div>
        <div class="card">
          <label>Quick Range</label>
          <div class="grid grid-2" style="gap:8px">
            <input type="date" id="homeFrom"/>
            <input type="date" id="homeTo"/>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><h3>Incoming</h3><div id="kIn" class="val">0</div></div>
        <div class="kpi"><h3>Outgoing</h3><div id="kOut" class="val">0</div></div>
        <div class="kpi"><h3>Returns + Adj</h3><div id="kRet" class="val">0</div></div>
        <div class="kpi"><h3>Balance</h3><div id="kBal" class="val">0</div></div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="homeLoad">Refresh</button>
        <button class="btn btn-ghost" id="openAdjust">Add Adjustment</button>
      </div>

      <div class="tablewrap">
        <table id="homeTable">
          <thead><tr><th>Date</th><th>Party</th><th>Yarn</th><th>Qty</th><th>Type</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- STOCK -->
    <section id="view-stock" class="hidden">
      <div class="grid grid-3">
        <div class="card"><label>Party</label><select id="sParty"></select></div>
        <div class="card"><label>Yarn (optional)</label><select id="sYarn"></select></div>
        <div class="card"><label>As of (optional)</label><input type="date" id="sAsOf"/></div>
      </div>
      <div class="actions"><button class="btn btn-primary" id="stockLoad">Show Stock</button></div>
      <div class="tablewrap">
        <table id="stockTable">
          <thead><tr><th>Yarn</th><th>Incoming</th><th>Outgoing</th><th>Return+Adj</th><th>Balance</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- LEDGER -->
    <section id="view-ledger" class="hidden">
      <div class="grid grid-3">
        <div class="card"><label>Party</label><select id="lParty"></select></div>
        <div class="card"><label>Yarn</label><select id="lYarn"></select></div>
        <div class="card">
          <label>Date Range</label>
          <div class="grid grid-2" style="gap:8px">
            <input type="date" id="lFrom"/>
            <input type="date" id="lTo"/>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="ledgerLoad">Load</button>
        <button class="btn btn-ghost" id="ledgerClear">Clear</button>
      </div>
      <div class="tablewrap">
        <table id="ledgerTable">
          <thead><tr><th>Date</th><th>Party</th><th>Yarn</th><th>Qty</th><th>Type</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Floating Nav -->
  <div class="nav">
    <div class="nav-inner">
      <div class="tab active" data-view="home">üè† Home</div>
      <div class="tab" data-view="stock">üì¶ Stock</div>
      <div class="tab" data-view="ledger">üìä Ledger</div>
      <div class="tab" id="tabAdd">‚ûï Add</div>
    </div>
  </div>

  <!-- Adjustment Modal -->
  <div id="modal">
    <div class="card">
      <h3 style="margin:0 0 10px">Add Adjustment</h3>
      <div class="grid grid-2">
        <div><label>Date</label><input id="adjDate" type="date"></div>
        <div><label>Qty (+/-)</label><input id="adjQty" type="number" step="0.01"></div>
        <div><label>Party</label><select id="adjParty"></select></div>
        <div><label>Yarn</label><select id="adjYarn"></select></div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" id="saveAdj">Save</button>
        <button class="btn btn-ghost" id="closeAdj">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastMsg"></span></div>

<!-- ===== APP LOGIC ===== -->
<script>
const API = "https://job-workrk.rkknitfabsachin.workers.dev"; // change if needed

const $ = (id) => document.getElementById(id);
const fmt = (n) => Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
const dmy = (d)=>{ const x=new Date(d); return isNaN(x)?String(d):x.toLocaleDateString('en-GB'); };

function toast(msg, type='info'){
  const t=$('toast'), m=$('toastMsg');
  m.textContent = msg;
  m.style.color = (type==='error')? 'var(--bad)' : 'var(--text)';
  t.classList.add('show');
  clearTimeout(toast._h); toast._h=setTimeout(()=>t.classList.remove('show'), 2200);
}

async function getJSON(url){
  // Robust fetch: timeout + graceful fallback
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), 8000);
  try{
    const r = await fetch(url, {signal: ctrl.signal});
    clearTimeout(timer);
    const t = await r.text();
    try { return JSON.parse(t); } catch(e){ console.error("Bad JSON:", t); throw e; }
  }catch(e){
    clearTimeout(timer);
    console.warn('Fetch failed for', url, e.message);
    toast('Network/API issue ‚Äî showing empty data', 'error');
    return [];
  }
}
async function postJSON(body){
  try{
    const r = await fetch(API, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const t = await r.text();
    try { return JSON.parse(t); } catch(e){ console.error("Bad JSON:", t); throw e; }
  }catch(e){ toast('POST failed: '+e.message,'error'); return {error:String(e)} }
}

/* -- Router -- */
function show(view){
  ["home","stock","ledger"].forEach(v => $("view-"+v).classList.toggle("hidden", v!==view));
  document.querySelectorAll(".tab[data-view]").forEach(t => t.classList.toggle("active", t.dataset.view===view));
}

/* -- Dependent yarn list -- */
async function filterYarnsFor(partySelectId, yarnSelectId){
  const party = $(partySelectId).value; if(!party){ $(yarnSelectId).value=''; return; }
  const rows = await getJSON(`${API}?action=ledger&party=${encodeURIComponent(party)}`);
  const set = [...new Set(rows.map(r=>r.yarn))].filter(Boolean).sort();
  $(yarnSelectId).innerHTML = `<option value="">All</option>` + set.map(y=>`<option>${y}</option>`).join("");
}

/* -- Masters -- */
async function loadMasters(){
  const pRes = await getJSON(`${API}?action=parties`);
  const yRes = await getJSON(`${API}?action=yarns`);
  const parties = Array.isArray(pRes) ? pRes : (Array.isArray(pRes?.parties) ? pRes.parties : []);
  const yarns   = Array.isArray(yRes) ? yRes : (Array.isArray(yRes?.yarns) ? yRes.yarns : []);

  ["homeParty","sParty","lParty","adjParty"].forEach(id=>{
    $(id).innerHTML = `<option value="">Select</option>` + parties.map(p=>`<option>${p}</option>`).join("");
  });
  ["homeYarn","sYarn","lYarn","adjYarn"].forEach(id=>{
    $(id).innerHTML = `<option value="">All</option>` + yarns.map(y=>`<option>${y}</option>`).join("");
  });
}

/* -- Home -- */
async function refreshHome(){
  const party = $("homeParty").value; if(!party) return alert("Select party");
  let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
  const yarn=$("homeYarn").value, from=$("homeFrom").value, to=$("homeTo").value;
  if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
  if(from) url += `&from=${from}`;
  if(to)   url += `&to=${to}`;
  const rows = await getJSON(url);

  let inc=0, out=0, ret=0, adj=0;
  rows.forEach(r=>{
    const q=Number(r.qty)||0;
    if(r.type==='Incoming') inc += q;
    else if(r.type==='Outgoing') out += Math.abs(q);
    else if(r.type==='Return') ret += q;
    else if(r.type==='Adjust') adj += q;
  });

  $("kIn").textContent = fmt(inc);
  $("kOut").textContent = fmt(out);
  $("kRet").textContent = fmt(ret+adj);
  $("kBal").textContent = fmt(inc - out + ret + adj);

  $("homeTable").querySelector("tbody").innerHTML = rows.map(r=>`
    <tr>
      <td>${dmy(r.date)}</td>
      <td>${r.party||""}</td>
      <td>${r.yarn||""}</td>
      <td class="${(Number(r.qty)||0)>=0?'pos':'neg'}">${fmt(r.qty)}</td>
      <td>${r.type||''}</td>
    </tr>`).join("");
}

/* -- Stock -- */
async function showStock(){
  const party = $("sParty").value; if(!party) return alert("Select party");
  let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
  const yarn=$("sYarn").value, asof=$("sAsOf").value;
  if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
  if(asof) url += `&to=${asof}`;
  const rows = await getJSON(url);

  const m = {};
  rows.forEach(r=>{
    const y = r.yarn || "‚Äî"; const q=Number(r.qty)||0;
    m[y] ??= {in:0,out:0,ret:0,adj:0};
    if(r.type==='Incoming') m[y].in += q;
    else if(r.type==='Outgoing') m[y].out += Math.abs(q);
    else if(r.type==='Return') m[y].ret += q;
    else if(r.type==='Adjust') m[y].adj += q;
  });

  $("stockTable").querySelector("tbody").innerHTML = Object.keys(m).sort().map(y=>{
    const bal = m[y].in - m[y].out + m[y].ret + m[y].adj;
    return `<tr>
      <td>${y}</td>
      <td>${fmt(m[y].in)}</td>
      <td>${fmt(m[y].out)}</td>
      <td>${fmt(m[y].ret + m[y].adj)}</td>
      <td class="${bal>=0?'pos':'neg'}">${fmt(bal)}</td>
    </tr>`;
  }).join("");
}

/* -- Ledger -- */
async function loadLedger(){
  const party = $("lParty").value; if(!party) return alert("Select party");
  let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
  const yarn=$("lYarn").value, from=$("lFrom").value, to=$("lTo").value;
  if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
  if(from) url += `&from=${from}`;
  if(to)   url += `&to=${to}`;
  const rows = await getJSON(url);

  $("ledgerTable").querySelector("tbody").innerHTML = rows.map(r=>`
    <tr>
      <td>${dmy(r.date)}</td>
      <td>${r.party||""}</td>
      <td>${r.yarn||""}</td>
      <td class="${(Number(r.qty)||0)>=0?'pos':'neg'}">${fmt(r.qty)}</td>
      <td>${r.type||''}</td>
    </tr>`).join("");
}

/* -- Init bindings -- */
document.addEventListener("DOMContentLoaded", () => {
  // Theme
  $("themeBtn").onclick = () => document.body.classList.toggle("light");

  // Router (ensure JS continues even if API fails)
  document.querySelectorAll(".tab[data-view]").forEach(t => t.onclick = () => show(t.dataset.view));
  show('home');

  // Modal
  const openModal = ()=>{ $("modal").classList.add("open"); $("adjDate").valueAsDate = new Date(); };
  const closeModal = ()=> $("modal").classList.remove("open");
  $("tabAdd").onclick = openModal;
  $("openAdjust").onclick = openModal;
  $("closeAdj").onclick = closeModal;
  $("modal").addEventListener("click", e => { if(e.target.id==="modal") closeModal(); });

  // Dependent yarns on party change
  ["homeParty","sParty","lParty","adjParty"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      const map = {homeParty:"homeYarn", sParty:"sYarn", lParty:"lYarn", adjParty:"adjYarn"};
      filterYarnsFor(id, map[id]);
    });
  });

  // Buttons
  $("homeLoad").onclick = refreshHome;
  $("stockLoad").onclick = showStock;
  $("ledgerLoad").onclick = loadLedger;
  $("ledgerClear").onclick = ()=>{ $("lYarn").value=""; $("lFrom").value=""; $("lTo").value=""; };

  // Save adjustment
  $("saveAdj").onclick = async ()=>{
    const body = {
      action:"addAdjust",
      date:$("adjDate").value,
      party:$("adjParty").value,
      yarn:$("adjYarn").value,
      qty:Number($("adjQty").value||0)
    };
    if(!body.party || !body.yarn || !body.date || !body.qty){
      return alert("Please fill all fields");
    }
    const res = await postJSON(body);
    if(res?.status==="ok"){ alert("Saved"); $("modal").classList.remove("open"); refreshHome(); }
    else alert("Backend error: "+JSON.stringify(res));
  };

  // Bootstrap (safe)
  loadMasters();

  // ---- Inline tests (won't block UI) ----
  setTimeout(()=>{
    console.assert(document.querySelectorAll('.tab[data-view]').length>=3, 'Tabs present');
    console.assert(document.getElementById('view-home'), 'Home view exists');
    console.assert(typeof show==='function', 'Router exists');
  }, 0);
});
</script>
</body>
</html>
