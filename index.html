<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK KNIT FAB ‚Äî Yarn Ledger</title>

<style>
:root{
  --bg:#0a0c12; --card:#111624; --glass:rgba(255,255,255,.06);
  --text:#eaf1ff; --muted:#9fb0d1; --line:rgba(255,255,255,.1);
  --accent:#35d7ff; --accent2:#00ffd5; --warn:#ffb020; --bad:#ff6b81; --ok:#7dff8c;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

.wrap{min-height:100vh;padding-bottom:90px}

/* BRAND HEADER */
.brand{position:sticky;top:0;z-index:20;backdrop-filter:blur(12px);
  background:rgba(10,12,18,.8);border-bottom:1px solid var(--line);}
.brand-inner{max-width:1200px;margin:auto;padding:14px 18px;
  display:flex;align-items:center;gap:12px}
.dot{width:10px;height:10px;border-radius:999px;background:var(--accent2);
  box-shadow:0 0 20px var(--accent2);}
.title{font-size:18px;font-weight:800;text-shadow:0 0 12px rgba(0,255,213,.4);}
.theme{border:1px solid var(--line);background:var(--glass);
  padding:8px 12px;border-radius:12px;cursor:pointer}

/* GRID */
.container{max-width:1200px;margin:auto;padding:20px}
.grid{display:grid;gap:14px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}

/* Cards */
.card{background:var(--card);border:1px solid var(--line);
  border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
select,input[type=date],input[type=number]{
  width:100%;padding:12px;background:transparent;color:var(--text);
  border-radius:12px;border:1px solid var(--line)
}

/* Buttons */
.actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.btn{padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;border:none}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001118}
.btn-ghost{background:transparent;border:1px solid var(--line);color:var(--text)}

/* KPI boxes */
.kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr);margin:14px 0}
@media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--glass);padding:14px;border-radius:14px;border:1px solid var(--line)}
.kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
.val{font-size:22px;font-weight:900}

/* TABLE */
.tablewrap{background:var(--card);border:1px solid var(--line);
  border-radius:16px;overflow:hidden;margin-top:12px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:12px 10px;border-bottom:1px solid var(--line)}
th{color:var(--muted);font-size:12px}
tr:hover td{background:rgba(53,215,255,.05)}
.pos{color:var(--ok);font-weight:800}
.neg{color:var(--bad);font-weight:800}

/* NAV */
.nav{position:fixed;left:0;right:0;bottom:16px;display:flex;justify-content:center;z-index:30}
.nav-inner{display:flex;gap:12px;padding:10px;background:rgba(255,255,255,.08);
  border:1px solid var(--line);backdrop-filter:blur(18px);border-radius:22px}
.tab{padding:10px 16px;border-radius:14px;cursor:pointer;display:flex;gap:6px;align-items:center}
.tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001118;font-weight:800}

/* Modal */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;
  align-items:center;justify-content:center;z-index:999}
.modal-box{background:var(--card);padding:20px;border-radius:16px;
  width:95%;max-width:520px;border:1px solid var(--line)}
</style>
</head>
<body>
<div class="wrap"> 
  
  <!-- BRAND HEADER -->
  <div class="brand">
    <div class="brand-inner">
      <span class="dot"></span>
      <div class="title">RK KNIT FAB ‚Äî Yarn Ledger</div>
      <div class="spacer"></div>
      <button id="themeBtn" class="theme">üåô</button>
    </div>
  </div>
<script>
const API = "https://job-workrk.rkknitfabsachin.workers.dev"; // or Apps Script URL

document.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2});
  const ddmmyyyy = (d) => {
    const x = new Date(d);
    return isNaN(x) ? String(d) : x.toLocaleDateString("en-GB");
  };

  // Theme
  $("themeBtn").onclick = () => document.body.classList.toggle("light");

  // Views
  const show = (v) => {
    ["home","stock","ledger"].forEach(s => $("view-"+s).classList.toggle("hidden", s!==v));
    document.querySelectorAll(".tab[data-view]").forEach(t => t.classList.toggle("active", t.dataset.view===v));
  };
  document.querySelectorAll(".tab[data-view]").forEach(t => t.onclick = () => show(t.dataset.view));

  // Modal open/close (open only when clicked)
  const modal = $("modal");
  const openModal = () => { modal.style.display = "flex"; $("adjDate").valueAsDate = new Date(); };
  const closeModal = () => { modal.style.display = "none"; };
  $("tabAdd").onclick = openModal;
  $("openAdjust").onclick = openModal;
  $("closeAdj").onclick = closeModal;
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

  // Simple fetch helpers with robust parsing
  const getJSON = async (url) => {
    const r = await fetch(url);
    const t = await r.text();
    try { return JSON.parse(t); } catch(e){ console.error("Bad JSON:", t); throw e; }
  };
  const postJSON = async (body) => {
    const r = await fetch(API, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const t = await r.text();
    try { return JSON.parse(t); } catch(e){ console.error("Bad JSON:", t); throw e; }
  };

  // Masters
  async function loadMasters(){
    const partiesResp = await getJSON(`${API}?action=parties`);
    const yarnsResp   = await getJSON(`${API}?action=yarns`);

    // Normalize to arrays safely
    const parties = Array.isArray(partiesResp) ? partiesResp :
                    Array.isArray(partiesResp?.parties) ? partiesResp.parties : [];
    const yarns   = Array.isArray(yarnsResp) ? yarnsResp :
                    Array.isArray(yarnsResp?.yarns) ? yarnsResp.yarns : [];

    ["homeParty","sParty","lParty","adjParty"].forEach(id=>{
      $(id).innerHTML = `<option value="">Select</option>` + parties.map(p=>`<option>${p}</option>`).join("");
    });
    ["homeYarn","sYarn","lYarn","adjYarn"].forEach(id=>{
      $(id).innerHTML = `<option value="">All</option>` + yarns.map(y=>`<option>${y}</option>`).join("");
    });
  }

  // Dependent yarn list by party
  async function filterYarns(selectPartyId, selectYarnId){
    const party = $(selectPartyId).value; if(!party) return;
    const rows = await getJSON(`${API}?action=ledger&party=${encodeURIComponent(party)}`);
    const set = [...new Set(rows.map(r=>r.yarn))].filter(Boolean).sort();
    $(selectYarnId).innerHTML = `<option value="">All</option>` + set.map(y=>`<option>${y}</option>`).join("");
  }
  ["homeParty","sParty","lParty","adjParty"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      const map = {homeParty:"homeYarn", sParty:"sYarn", lParty:"lYarn", adjParty:"adjYarn"};
      filterYarns(id, map[id]);
    });
  });

  // HOME
  $("homeLoad").onclick = async ()=>{
    const party = $("homeParty").value; if(!party) return alert("Select party");
    let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
    const yarn=$("homeYarn").value, from=$("homeFrom").value, to=$("homeTo").value;
    if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
    if(from) url += `&from=${from}`;
    if(to)   url += `&to=${to}`;
    const rows = await getJSON(url);

    let inc=0,out=0,ret=0,adj=0;
    rows.forEach(r=>{
      if(r.type==='Incoming') inc+=r.qty;
      else if(r.type==='Outgoing') out+=Math.abs(r.qty);
      else if(r.type==='Return') ret+=r.qty;
      else if(r.type==='Adjust') adj+=r.qty;
    });

    $("kIn").textContent=fmt(inc);
    $("kOut").textContent=fmt(out);
    $("kRet").textContent=fmt(ret+adj);
    $("kBal").textContent=fmt(inc-out+ret+adj);

    $("homeTable").querySelector("tbody").innerHTML =
      rows.map(r=>`<tr>
        <td>${ddmmyyyy(r.date)}</td>
        <td>${r.party||''}</td>
        <td>${r.yarn||''}</td>
        <td class="${r.qty>=0?'pos':'neg'}">${fmt(r.qty)}</td>
        <td>${r.type}</td>
      </tr>`).join("");
  };

  // STOCK
  $("stockLoad").onclick = async ()=>{
    const party = $("sParty").value; if(!party) return alert("Select party");
    let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
    const yarn=$("sYarn").value, asof=$("sAsOf").value;
    if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
    if(asof) url += `&to=${asof}`;
    const rows = await getJSON(url);

    const m = {};
    rows.forEach(r=>{
      const y=r.yarn||'‚Äî';
      m[y] ??= {in:0,out:0,ret:0,adj:0};
      if(r.type==='Incoming') m[y].in+=r.qty;
      else if(r.type==='Outgoing') m[y].out+=Math.abs(r.qty);
      else if(r.type==='Return') m[y].ret+=r.qty;
      else if(r.type==='Adjust') m[y].adj+=r.qty;
    });

    $("stockTable").querySelector("tbody").innerHTML =
      Object.keys(m).sort().map(y=>{
        const bal = m[y].in - m[y].out + m[y].ret + m[y].adj;
        return `<tr>
          <td>${y}</td>
          <td>${fmt(m[y].in)}</td>
          <td>${fmt(m[y].out)}</td>
          <td>${fmt(m[y].ret + m[y].adj)}</td>
          <td class="${bal>=0?'pos':'neg'}">${fmt(bal)}</td>
        </tr>`;
      }).join("");
  };

  // LEDGER
  $("ledgerLoad").onclick = async ()=>{
    const party = $("lParty").value; if(!party) return alert("Select party");
    let url = `${API}?action=ledger&party=${encodeURIComponent(party)}`;
    const yarn=$("lYarn").value, from=$("lFrom").value, to=$("lTo").value;
    if(yarn) url += `&yarn=${encodeURIComponent(yarn)}`;
    if(from) url += `&from=${from}`;
    if(to)   url += `&to=${to}`;
    const rows = await getJSON(url);

    $("ledgerTable").querySelector("tbody").innerHTML =
      rows.map(r=>`<tr>
        <td>${ddmmyyyy(r.date)}</td>
        <td>${r.party||''}</td>
        <td>${r.yarn||''}</td>
        <td class="${r.qty>=0?'pos':'neg'}">${fmt(r.qty)}</td>
        <td>${r.type}</td>
      </tr>`).join("");
  };

  $("ledgerClear").onclick = ()=> { $("lYarn").value=""; $("lFrom").value=""; $("lTo").value=""; };

  // SAVE ADJUSTMENT
  $("saveAdj").onclick = async ()=>{
    const body = {
      action:'addAdjust',
      date:$("adjDate").value,
      party:$("adjParty").value,
      yarn:$("adjYarn").value,
      qty:Number($("adjQty").value||0)
    };
    if(!body.party || !body.yarn || !body.date || !body.qty){
      return alert("Please fill all fields");
    }
    const res = await postJSON(body);
    if(res?.status === 'ok'){ alert('Saved'); closeModal(); $("homeLoad").click(); }
    else alert('Backend error: '+JSON.stringify(res));
  };

  // INIT
  (async ()=>{
    await loadMasters();
  })();
});
</script>
</body>
</html>

  <div class="container">
    <!-- HOME -->
    <section id="view-home">
      <div class="grid grid-3">
        <div class="card">
          <label>Quick Party</label>
          <select id="homeParty"></select>
        </div>
        <div class="card">
          <label>Quick Yarn</label>
          <select id="homeYarn"></select>
        </div>
        <div class="card">
          <label>Quick Range</label>
          <div class="grid grid-2" style="gap:8px">
            <input type="date" id="homeFrom"/>
            <input type="date" id="homeTo"/>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><h3>Incoming</h3><div id="kIn" class="val">0</div></div>
        <div class="kpi"><h3>Outgoing</h3><div id="kOut" class="val">0</div></div>
        <div class="kpi"><h3>Returns + Adj</h3><div id="kRet" class="val">0</div></div>
        <div class="kpi"><h3>Balance</h3><div id="kBal" class="val">0</div></div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" id="homeLoad">Refresh</button>
        <button class="btn btn-ghost" id="openAdjust">Add Adjustment</button>
      </div>

      <div class="tablewrap">
        <table id="homeTable">
          <thead>
            <tr><th>Date</th><th>Party</th><th>Yarn</th><th>Qty</th><th>Type</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- STOCK -->
    <section id="view-stock" class="hidden">
      <div class="grid grid-3">
        <div class="card"><label>Party</label><select id="sParty"></select></div>
        <div class="card"><label>Yarn (optional)</label><select id="sYarn"></select></div>
        <div class="card"><label>As of (optional)</label><input type="date" id="sAsOf"/></div>
      </div>
      <div class="actions"><button class="btn btn-primary" id="stockLoad">Show Stock</button></div>
      <div class="tablewrap">
        <table id="stockTable">
          <thead><tr><th>Yarn</th><th>Incoming</th><th>Outgoing</th><th>Return+Adj</th><th>Balance</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- LEDGER -->
    <section id="view-ledger" class="hidden">
      <div class="grid grid-3">
        <div class="card"><label>Party</label><select id="lParty"></select></div>
        <div class="card"><label>Yarn</label><select id="lYarn"></select></div>
        <div class="card">
          <label>Date Range</label>
          <div class="grid grid-2" style="gap:8px">
            <input type="date" id="lFrom"/><input type="date" id="lTo"/>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" id="ledgerLoad">Load</button>
        <button class="btn btn-ghost" id="ledgerClear">Clear</button>
      </div>
      <div class="tablewrap">
        <table id="ledgerTable">
          <thead><tr><th>Date</th><th>Party</th><th>Yarn</th><th>Qty</th><th>Type</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="tab active" data-view="home">üè† Home</div>
      <div class="tab" data-view="stock">üì¶ Stock</div>
      <div class="tab" data-view="ledger">üìä Ledger</div>
      <div class="tab" id="tabAdd">‚ûï Add</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 style="margin:0 0 10px">Add Adjustment</h3>
    <div class="grid grid-2" style="gap:10px">
      <div><label>Date</label><input id="adjDate" type="date"></div>
      <div><label>Qty (+/-)</label><input id="adjQty" type="number" step="0.01"></div>
      <div><label>Party</label><select id="adjParty"></select></div>
      <div><label>Yarn</label><select id="adjYarn"></select></div>
    </div>
    <div class="actions">
      <button class="btn btn-primary" id="saveAdj">Save</button>
      <button class="btn btn-ghost" id="closeAdj">Close</button>
    </div>
  </div>
</div>

